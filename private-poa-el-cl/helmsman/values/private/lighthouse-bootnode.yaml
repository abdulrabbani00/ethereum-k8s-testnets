replicas: 1

podManagementPolicy: Parallel

mode: "beacon"

customCommand:
- sh
- -ac
- >
  lighthouse -l beacon_node
  --datadir=/data
  --disable-upnp
  --disable-enr-auto-update
  --enr-address=$(POD_IP)
  --enr-tcp-port=9000
  --enr-udp-port=9000
  --listen-address=0.0.0.0
  --port=9000
  --discovery-port=9000
  --http
  --http-address=0.0.0.0
  --http-port=5052
  --metrics
  --metrics-address=0.0.0.0
  --metrics-port=5054
  --testnet-dir=/data/testnet_spec
  --eth1
  --eth1-endpoints=http://dshackle.ethereum-private.svc.cluster.local:8545/eth
  --target-peers=500
  --debug-level=trace
extraArgs:
  - --testnet-dir=/data/testnet_spec
  - --disable-discovery
  - --eth1
  - --eth1-endpoints=http://dshackle.ethereum-private.svc.cluster.local:8545/eth
  - --target-peers=500
  - --debug-level=trace

extraEnv:
  - name: RUST_LOG
    value: discv5=trace

initContainers:
- name: init-genesis
  image: alpine:latest
  imagePullPolicy: IfNotPresent
  securityContext:
    runAsNonRoot: false
    runAsUser: 0
  command:
    - sh
    - -ace
    - >
      mkdir -p /data/testnet_spec;
      if ! [ -f /data/testnet_spec/genesis.ssz ];
      then
        echo "waiting for genesis provider";
        while ! wget -T 5 -c http://genesis-generator:8001/cl/; do sleep 10; done;
        wget -O /data/testnet_spec/deposit_contract.txt http://genesis-generator:8001/cl/deposit_contract.txt;
        wget -O /data/testnet_spec/deploy_block.txt http://genesis-generator:8001/cl/deploy_block.txt;
        wget -O /data/testnet_spec/config.yaml http://genesis-generator:8001/cl/config.yaml;
        wget -O /data/testnet_spec/genesis.ssz http://genesis-generator:8001/cl/genesis.ssz;
        echo "genesis init done";
      else
        echo "genesis exists. skipping...";
      fi
  volumeMounts:
    - name: storage
      mountPath: "/data"

extraContainers:
  - name: enr-http
    image: msoap/shell2http:1.13
    imagePullPolicy: IfNotPresent
    command:
    - sh
    - -ace
    - >
      while [ ! -f /data/beacon/network/enr.dat ]; do sleep 2; done;
      /app/shell2http -port 8888 /enr "cat /data/beacon/network/enr.dat";
    volumeMounts:
      - name: storage
        mountPath: "/data"
        readOnly: true
    ports:
      - name: enr-http
        containerPort: 8888
        protocol: TCP

persistence:
  enabled: true
  accessModes:
  - ReadWriteOnce
  size: 1Gi
  storageClassName: do-block-storage

#livenessProbe: null
#
#readinessProbe:
#  tcpSocket: null
#  httpGet:
#    path: /enr
#    port: 8888
#  initialDelaySeconds: 5
#  periodSeconds: 5

resources: {}

serviceMonitor:
  enabled: true
